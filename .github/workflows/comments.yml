name: Process Comments

on:
  issues:
    types: [opened, edited]

jobs:
  process-comment:
    if: contains(github.event.issue.labels.*.name, 'نظر')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Process issue as comment
      run: |
        # ایجاد پوشه comments اگر وجود ندارد
        mkdir -p _data/comments
        
        # استخراج اطلاعات از Issue
        ISSUE_BODY="${{ github.event.issue.body }}"
        ISSUE_TITLE="${{ github.event.issue.title }}"
        ISSUE_URL="${{ github.event.issue.html_url }}"
        
        # استخراج اسلاگ پست از لیبل‌ها
        SLUG=""
        for label in ${{ join(github.event.issue.labels.*.name, ' ') }}; do
          if [[ "$label" != "نظر" ]]; then
            SLUG="$label"
            break
          fi
        done
        
        # استخراج نام کاربر
        NAME=$(echo "$ISSUE_BODY" | grep -oP '(?<=\*\*نام:\*\* ).*' || echo "کاربر گیت‌هاب")
        
        # استخراج تاریخ
        DATE=$(echo "$ISSUE_BODY" | grep -oP '(?<=\*\*تاریخ:\*\* ).*' || echo "$(date +'%Y/%m/%d %H:%M')")
        
        # استخراج متن نظر
        MESSAGE=$(echo "$ISSUE_BODY" | sed -n '/\*\*متن نظر:\*\*/,/---/p' | tail -n +2 | head -n -1)
        
        # فایل نظرات پست
        COMMENTS_FILE="_data/comments/${SLUG}.json"
        
        # اگر فایل وجود نداره، آرایه خالی بساز
        if [ ! -f "$COMMENTS_FILE" ]; then
          echo "[]" > "$COMMENTS_FILE"
        fi
        
        # نظر جدید
        jq --arg name "$NAME" \
           --arg message "$MESSAGE" \
           --arg date "$DATE" \
           --arg url "$ISSUE_URL" \
           '. += [{
             "name": $name,
             "message": $message,
             "date": $date,
             "url": $url,
             "issue_number": ${{ github.event.issue.number }}
           }]' "$COMMENTS_FILE" > tmp.json && mv tmp.json "$COMMENTS_FILE"
        
    - name: Commit and push
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        git add _data/comments/
        git commit -m "Add comment from issue #${{ github.event.issue.number }}"
        git push
