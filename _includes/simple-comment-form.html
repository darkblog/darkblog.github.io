<!-- _includes/simple-comment-form.html -->
<div class="simple-comment-box">
  <form id="simpleCommentForm" class="simple-comment-form">
    <div class="comment-input-group">
      <input 
        type="text" 
        id="commenterName" 
        name="name" 
        placeholder="Ù†Ø§Ù… Ø´Ù…Ø§ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶: Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†)" 
        autocomplete="name"
        class="comment-name-input"
      >
      <button type="submit" class="comment-submit-btn" id="submitCommentBtn">
        <span>Ø§Ø±Ø³Ø§Ù„ Ù†Ø¸Ø±</span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
        </svg>
      </button>
    </div>
    
    <div class="comment-textarea-group">
      <textarea 
        id="commentText" 
        name="message" 
        rows="3" 
        placeholder="Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." 
        required
        class="comment-textarea"
      ></textarea>
    </div>
    
    <input type="hidden" id="commentPostSlug" value="{{ page.slug | default: page.url | slugify }}">
    <input type="hidden" id="commentPostTitle" value="{{ page.title | escape }}">
    <input type="hidden" id="commentTimestamp" value="">
  </form>
  
  <div id="commentStatus" class="comment-status" style="display: none;"></div>
</div>

<script>
// ==================== Ø³ÛŒØ³ØªÙ… Ú©Ø§Ù…Ù†Øª Ø¯Ø§Ø®Ù„ÛŒ ====================
(function() {
  'use strict';
  
  // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø¸Ø±Ø§Øª Ù‡Ù†Ú¯Ø§Ù… Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡
  function loadComments() {
    const postSlug = document.getElementById('commentPostSlug')?.value;
    if (!postSlug) return;
    
    const comments = JSON.parse(localStorage.getItem('blogComments') || '{}');
    const postComments = comments[postSlug] || [];
    
    const commentsContainer = document.getElementById('commentsList');
    if (commentsContainer) {
      commentsContainer.innerHTML = '';
      if (postComments.length === 0) {
        commentsContainer.innerHTML = '<div class="no-comments-mini">Ù‡Ù†ÙˆØ² Ù†Ø¸Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡. Ø§ÙˆÙ„ÛŒÙ† Ù†ÙØ± Ø¨Ø§Ø´!</div>';
      } else {
        // Ù†Ù…Ø§ÛŒØ´ Ø§Ø² Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù‚Ø¯ÛŒÙ…
        postComments.reverse().forEach(displayComment);
      }
    }
    
    updateCommentsCount(postComments.length);
  }
  
  // Ù†Ù…Ø§ÛŒØ´ ÛŒÚ© Ù†Ø¸Ø±
  function displayComment(comment) {
    const commentsContainer = document.getElementById('commentsList');
    if (!commentsContainer) return;
    
    // Ø­Ø°Ù Ù¾ÛŒØ§Ù… "Ù†Ø¸Ø±ÛŒ Ù†ÛŒØ³Øª" Ø§Ú¯Ù‡ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù‡
    const noCommentsMsg = commentsContainer.querySelector('.no-comments-mini');
    if (noCommentsMsg) noCommentsMsg.remove();
    
    const commentElement = document.createElement('div');
    commentElement.className = 'comment-item-mini';
    commentElement.id = comment.id;
    commentElement.setAttribute('data-comment-id', comment.id);
    
    // ØªØ§Ø±ÛŒØ® Ø±Ùˆ Ø¨Ù‡ ÙØ±Ù…Øª ÙØ§Ø±Ø³ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
    let displayDate = comment.date;
    if (!displayDate) {
      displayDate = new Date().toLocaleDateString('fa-IR');
    }
    
    commentElement.innerHTML = `
      <div class="comment-header-mini">
        <span class="comment-name-mini">${escapeHtml(comment.name || 'Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†')}</span>
        <span class="comment-date-mini">${escapeHtml(displayDate)}</span>
      </div>
      <div class="comment-body-mini">${escapeHtml(comment.message).replace(/\n/g, '<br>')}</div>
    `;
    
    commentsContainer.prepend(commentElement);
  }
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¹Ø¯Ø§Ø¯ Ù†Ø¸Ø±Ø§Øª
  function updateCommentsCount(count) {
    const countElement = document.getElementById('commentsCount');
    if (countElement) {
      countElement.textContent = count || 0;
    }
  }
  
  // ÙØ±Ø§Ø± Ø§Ø² Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ HTML
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Ø°Ø®ÛŒØ±Ù‡ Ù†Ø¸Ø± Ø¬Ø¯ÛŒØ¯
  function saveComment(commentData) {
    // Ø¯Ø±ÛŒØ§ÙØª Ù†Ø¸Ø±Ø§Øª Ù…ÙˆØ¬ÙˆØ¯
    const allComments = JSON.parse(localStorage.getItem('blogComments') || '{}');
    const postSlug = commentData.post;
    
    if (!allComments[postSlug]) {
      allComments[postSlug] = [];
    }
    
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù†Ø¸Ø± Ø¬Ø¯ÛŒØ¯
    allComments[postSlug].push(commentData);
    
    // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage
    localStorage.setItem('blogComments', JSON.stringify(allComments));
    
    return allComments[postSlug].length;
  }
  
  // Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù…
  function handleFormSubmit(e) {
    e.preventDefault();
    
    const nameInput = document.getElementById('commenterName');
    const commentInput = document.getElementById('commentText');
    const postSlug = document.getElementById('commentPostSlug').value;
    const postTitle = document.getElementById('commentPostTitle').value;
    const statusDiv = document.getElementById('commentStatus');
    const submitBtn = document.getElementById('submitCommentBtn');
    
    // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
    const commentText = commentInput.value.trim();
    if (!commentText) {
      showStatus('Ù„Ø·ÙØ§Ù‹ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯', 'error', statusDiv);
      return;
    }
    
    // Ø¯ÛŒØ²Ø§ÛŒÙ† Ø¯Ú©Ù…Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span>Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...</span>';
    
    // ØªÙ†Ø¸ÛŒÙ… Ù†Ø§Ù…: Ø§Ú¯Ø± Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ â†’ Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†
    let commenterName = nameInput.value.trim();
    if (!commenterName) {
      commenterName = 'Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†';
    }
    
    // Ø³Ø§Ø®Øª Ù†Ø¸Ø± Ø¬Ø¯ÛŒØ¯
    const now = new Date();
    const persianDate = now.toLocaleDateString('fa-IR', {
      year: 'numeric',
      month: 'numeric', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    const commentData = {
      id: 'comment-' + Date.now() + '-' + Math.random().toString(36).substring(2, 6),
      name: commenterName,
      message: commentText,
      post: postSlug,
      postTitle: postTitle,
      date: persianDate,
      timestamp: now.toISOString()
    };
    
    // Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ù†Ù…Ø§ÛŒØ´
    const totalComments = saveComment(commentData);
    displayComment(commentData);
    updateCommentsCount(totalComments);
    
    // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
    showStatus('âœ… Ù†Ø¸Ø± Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯', 'success', statusDiv);
    
    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù… (ÙÙ‚Ø· Ù…ØªÙ† Ù†Ø¸Ø±ØŒ Ø§Ø³Ù… Ø±Ùˆ Ù†Ú¯Ù‡ Ø¯Ø§Ø±)
    commentInput.value = '';
    
    // Ø¨Ø±Ú¯Ø±Ø¯ÙˆÙ†Ø¯Ù† Ø¯Ú©Ù…Ù‡
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<span>Ø§Ø±Ø³Ø§Ù„ Ù†Ø¸Ø±</span><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/></svg>';
  }
  
  // Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª
  function showStatus(message, type, statusDiv) {
    if (!statusDiv) return;
    
    statusDiv.textContent = message;
    statusDiv.className = 'comment-status ' + type;
    statusDiv.style.display = 'block';
    
    setTimeout(() => {
      statusDiv.style.opacity = '0';
      setTimeout(() => {
        statusDiv.style.display = 'none';
        statusDiv.style.opacity = '1';
        statusDiv.className = 'comment-status';
      }, 300);
    }, 3000);
  }
  
  // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ù†Ø¸Ø±Ø§Øª ÛŒÚ© Ù¾Ø³Øª (Ø¨Ø±Ø§ÛŒ ØªØ³Øª)
  window.clearPostComments = function() {
    const postSlug = document.getElementById('commentPostSlug')?.value;
    if (!postSlug) return;
    
    if (confirm('Ù‡Ù…Ù‡ Ù†Ø¸Ø±Ø§Øª Ø§ÛŒÙ† Ù¾Ø³Øª Ù¾Ø§Ú© Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯ØŸ')) {
      const allComments = JSON.parse(localStorage.getItem('blogComments') || '{}');
      delete allComments[postSlug];
      localStorage.setItem('blogComments', JSON.stringify(allComments));
      
      const commentsContainer = document.getElementById('commentsList');
      if (commentsContainer) {
        commentsContainer.innerHTML = '<div class="no-comments-mini">Ù‡Ù†ÙˆØ² Ù†Ø¸Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡. Ø§ÙˆÙ„ÛŒÙ† Ù†ÙØ± Ø¨Ø§Ø´!</div>';
      }
      
      updateCommentsCount(0);
      showStatus('ğŸ—‘ï¸ Ù‡Ù…Ù‡ Ù†Ø¸Ø±Ø§Øª Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯', 'success', document.getElementById('commentStatus'));
    }
  };
  
  // Ø´Ø±ÙˆØ¹ Ú©Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ø² Ù„ÙˆØ¯ ØµÙØ­Ù‡
  document.addEventListener('DOMContentLoaded', function() {
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø¸Ø±Ø§Øª
    loadComments();
    
    // Ø§ØªØµØ§Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¨Ù‡ ÙØ±Ù…
    const form = document.getElementById('simpleCommentForm');
    if (form) {
      form.addEventListener('submit', handleFormSubmit);
    }
  });
})();
</script>
